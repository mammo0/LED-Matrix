name: LED-Matrix Venv

on:
  push:
    branches:
      - master
    tags:
      - v*
  pull_request:

env:
    RELEASE_ASSET_ZIP_FILE: LED-Matrix_virtuelenv.tar.gz

jobs:
  test:
    name: Build LED-Matrix Venv
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v3
        - name: Set up QEMU
          id: qemu
          uses: docker/setup-qemu-action@v2
          with:
              platforms: arm
        - name: Set up Python
          # by default uses the .python-version file
          uses: actions/setup-python@v4
        - name: Set up Poetry
          uses: abatilo/actions-poetry@v2

        # build virtual Python environment for Raspberry Pi
        - name: Build Venv
          run: make build-alpine-venv

        # create the GH release
        - name: Prepare release
          if: startsWith(github.event.ref, 'refs/tags')
          id: prepare_release
          run: |
              echo ::set-output name=alpine_ver::${GITHUB_REF_NAME%-*}
              echo ::set-output name=release_num::${GITHUB_REF_NAME#*-}
        - name: Create GH Release
          if: startsWith(github.event.ref, 'refs/tags')
          id: create_release
          uses: actions/create-release@v1
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
              tag_name: ${{ github.ref }}
              release_name: LED-Matrix Venv r${{ steps.prepare_release.outputs.release_num }} (Alpine Linux ${{ steps.prepare_release.outputs.alpine_ver }})
              draft: false
              prerelease: false
        - name: Upload Venv archive
          if: startsWith(github.event.ref, 'refs/tags')
          uses: actions/upload-release-asset@v1
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
              upload_url: ${{ steps.create_release.outputs.upload_url }}
              asset_path: resources/${{ env.RELEASE_ASSET_ZIP_FILE }}
              asset_name: ${{ env.RELEASE_ASSET_ZIP_FILE }}
              asset_content_type: application/zip
